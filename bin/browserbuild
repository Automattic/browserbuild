#!/usr/bin/env node

var program = require('commander')
  , path = require('path')
  , fs = require('fs')
  , pwd = process.cwd()

// reads a client-side file

function read (file) {
  return fs.readFileSync(file, 'utf8')
}

// source for client-side require

var source = read(__dirname + '/../lib/require.js')
  .replace(/\/*([^/]+)\/\n/g, '')
  .replace(/\n/g, '')
  .replace(/ +/g, ' ')

// program

program
  .version(require('../package').version)
  .usage('[options] <file â€¦>')
  .option('-g, --global [name]', 'Name of the global to export.')
  .option('-b, --basepath [name]', 'Base path of supplied files ['+ pwd + '].', pwd)
  .option('-m, --main <name>', 'Name of the main file/module to export.')
  .option('-d, --debug', 'Includes visionmedia/debug for a dev build.')
  .parse(process.argv)

// validate

if (!program.main) {
  console.error('\n  Please supply a `main` option\n');
  return;
}

if (!program.args.length) {
  console.error('\n  Please supply files.\n');
  return;
}

// process argument

var target = program.args
  , mod = path.basename(program.main)

function handle (path) {
  var stat = fs.statSync(path);

  if (stat.isDirectory()) {
    var files = fs.readdirSync(path);

    files.forEach(function (f) {
      handle(path + '/' + f);
    });
  } else {
    var base = program.basepath
      , source = fs.readFileSync(path, 'utf8')

    if (base && base == path.substr(0, base.length)) {
      path = path.substr(base.length);
    }

    data += 'require.register("' + path + '", '
      + 'function(module, exports, require, global){\n' + source + '\n});';
  }
};

// debug
if (program.debug) {
  debug = read(__dirname + '/../node_modules/debug/debug.js');
} else {
  debug = 'function debug(){};';
}

// head
var data = '(function(){'
  + 'var global = this;'
  + debug
  + source

// handle files
program.args.forEach(handle);

// tail
data += (program.global || program.main) + ' = require(\'' + mod + '\');\n';
data += '})();';

console.log(data);
